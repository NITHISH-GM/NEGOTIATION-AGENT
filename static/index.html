<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Negotiation Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* General Styling */
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
    }

    /* Main App Container */
    .app {
        width: 100%;
        max-width: 700px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px  24px rgba(0,0,0,0.08);
        padding: 25px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    h1 {
        text-align: center;
        color: #1c1e21;
        margin-top: 0;
        margin-bottom: 25px;
        font-size: 1.8rem;
    }

    /* Initial Setup Inputs */
    .inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .inputs input {
        padding: 12px 15px;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .inputs input:focus {
        outline: none;
        border-color: #1877f2;
        box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    /* Chat Window */
    .chat {
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        padding: 15px;
        height: 450px;
        overflow-y: auto;
        margin-bottom: 20px;
        background: #f7f8fa;
        display: flex;
        flex-direction: column;
    }

    /* Individual Message Bubbles */
    .message {
        margin: 8px 0;
        padding: 12px 18px;
        border-radius: 18px;
        line-height: 1.5;
        max-width: 75%;
        word-wrap: break-word;
    }

    .message strong {
        display: block;
        margin-bottom: 4px;
        font-size: 0.85rem;
        color: #65676b;
    }
    
    .message.seller {
        background: #e7f3ff;
        color: #001c3d;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    .message.seller strong { color: #1877f2; }

    .message.buyer {
        background: #e8f5e9;
        color: #143615;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    .message.buyer strong { color: #42b72a; }

    .message.system, .message.error {
        background: #fff3e0;
        color: #5c3c00;
        align-self: center;
        max-width: 90%;
        text-align: center;
        font-size: 0.9rem;
        border-radius: 8px;
    }

    .message.loading {
        background: #f0f0f0;
        color: #666;
        font-style: italic;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    /* Message Input Controls */
    .controls {
        display: flex;
        gap: 10px;
    }

    .controls input {
        flex-grow: 1;
        padding: 12px 15px;
        border: 1px solid #dddfe2;
        border-radius: 20px;
        font-size: 16px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .controls input:focus {
        outline: none;
        border-color: #1877f2;
        box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
    }

    .controls button {
        padding: 12px 20px;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background-color 0.2s, transform 0.1s;
    }
    .controls button:active { transform: scale(0.98); }

    .controls button.send { background: #1877f2; }
    .controls button.send:hover { background: #166fe5; }
    
    .controls button.reset { background: #fa383e; }
    .controls button.reset:hover { background: #e33136; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Buyer Agent Negotiation</h1>
    <div class="inputs">
      <input id="product" type="text" placeholder="Product (e.g., Laptop)">
      <input id="budget" type="number" placeholder="Your Budget (â‚¹)">
    </div>
    <div class="chat" id="chat"></div>
    <div class="controls">
      <input id="sellerMsg" type="text" placeholder="Enter seller's offer price...">
      <button class="send" onclick="sendMessage()">Send</button>
      <button class="reset" onclick="resetSession()">Reset</button>
    </div>
  </div>

  <script>
    let sessionId = null;
    const productInput = document.getElementById("product");
    const budgetInput = document.getElementById("budget");
    const sellerMsgInput = document.getElementById("sellerMsg");
    const chatWindow = document.getElementById("chat");

    // Allow sending messages with the Enter key
    sellerMsgInput.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const product = productInput.value.trim();
        const budgetStr = budgetInput.value.trim();
        const sellerMsg = sellerMsgInput.value.trim();
        
        // --- Input Validation ---
        if (!product || !budgetStr) {
            addMessage("System", "Please set a Product and your Budget before starting.", "error");
            return;
        }
        if (!sellerMsg) {
            addMessage("System", "Please enter the seller's offer price.", "error");
            return;
        }
        
        const budget = parseInt(budgetStr);
        const offer = parseInt(sellerMsg);

        if (isNaN(budget) || isNaN(offer) || budget <= 0 || offer <= 0) {
            addMessage("System", "Budget and Offer must be positive numbers.", "error");
            return;
        }

        // --- UI Updates ---
        addMessage("You (Seller)", `Offer: â‚¹${offer.toLocaleString('en-IN')}`, "seller");
        sellerMsgInput.value = "";
        productInput.disabled = true; // Lock product/budget during negotiation
        budgetInput.disabled = true;
        
        const loadingElem = addMessage("Buyer Agent", 'ðŸ¤” Thinking...', "loading");

        try {
            // --- API Call ---
            const apiUrl = `${window.location.origin}/api/negotiate`;
            const res = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    product, 
                    budget,
                    seller_message: sellerMsg, // Backend expects the raw number string
                    session_id: sessionId
                })
            });

            loadingElem.remove();

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || "An unknown server error occurred.");
            }

            const data = await res.json();
            sessionId = data.session_id;
            
            const r = data.response;
            addMessage("Buyer Agent", r.message, "buyer");
            
        } catch (error) {
            // Ensure loading indicator is removed on error
            if (loadingElem.parentNode) {
                loadingElem.remove();
            }
            addMessage("System", `Error: ${error.message}`, "error");
        }
    }

    function addMessage(sender, text, cls) {
        const div = document.createElement("div");
        div.className = `message ${cls}`;
        // Sanitize text content to prevent HTML injection
        const strong = document.createElement("strong");
        strong.textContent = `${sender}:`;
        div.appendChild(strong);
        div.append(document.createTextNode(text));
        
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the latest message
        return div;
    }

    async function resetSession() {
        if (sessionId) {
            try {
                const apiUrl = `${window.location.origin}/api/reset`;
                await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ session_id: sessionId })
                });
            } catch (error) {
                console.error("Session reset failed:", error);
            }
        }
        
        sessionId = null;
        chatWindow.innerHTML = "";
        productInput.value = "";
        budgetInput.value = "";
        sellerMsgInput.value = "";

        // Unlock the product and budget fields
        productInput.disabled = false;
        budgetInput.disabled = false;

        addMessage("System", "New negotiation session started. Please set your product and budget.", "system");
        productInput.focus();
    }

    // Initialize the app on page load
    document.addEventListener("DOMContentLoaded", () => {
        resetSession();
    });
  </script>
</body>
</html>

